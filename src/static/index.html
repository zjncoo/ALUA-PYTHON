<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALUA Control Room</title>
    <link rel="icon" href="/static/logo_alua.svg" type="image/svg+xml">

    <style>
        @font-face {
            font-family: 'Bergen Mono';
            src: url('/static/BergenMono-Regular.ttf') format('truetype');
            font-weight: normal;
        }

        :root {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --border: #000000;
            --accent: #000000;
            --success: #22c55e;
            --text-main: #000000;
            --text-dim: #666666;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Bergen Mono', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* LAYOUT */
        header {
            background: var(--card-bg);
            border-bottom: 2px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            /* Controls | Timeline | Live Data */
            gap: 2px;
            background: var(--border);
            /* Creates grid lines */
            overflow: hidden;
        }

        .pane {
            background: var(--card-bg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            background: #eee;
            padding: 0.75rem 1rem;
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 2px solid var(--border);
            letter-spacing: 0.1em;
            display: flex;
            justify-content: space-between;
        }

        /* CONTROLS (Left) */
        .control-group {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .btn {
            width: 100%;
            background: black;
            color: white;
            border: none;
            padding: 1rem;
            text-transform: uppercase;
            font-family: inherit;
            font-weight: bold;
            letter-spacing: 0.1em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-stop {
            background: white;
            color: red;
            border: 2px solid red;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }



        /* TIMELINE (Center) */
        .timeline-list {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .t-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            background: #fafafa;
            align-items: center;
            opacity: 0.7;
        }

        .t-item.active {
            opacity: 1;
            border: 2px solid black;
            background: white;
            box-shadow: 4px 4px 0 black;
            transform: translateX(-2px);
        }

        .t-time {
            font-size: 0.7rem;
            color: #999;
            width: 50px;
            text-align: right;
        }

        .t-content {
            flex: 1;
        }

        .t-title {
            font-weight: bold;
            text-transform: uppercase;
        }

        .t-meta {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        /* LIVE DATA (Right) */
        .module {
            padding: 1.5rem;
            border-bottom: 2px solid #eee;
        }

        .module-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 1rem;
            letter-spacing: 0.1em;
        }

        /* Sliders */
        .slider-viz {
            display: flex;
            gap: 10px;
            height: 150px;
            align-items: flex-end;
            justify-content: center;
        }

        .bar-container {
            width: 40px;
            background: #eee;
            height: 100%;
            position: relative;
            border: 1px solid #ccc;
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: black;
            transition: height 0.2s;
        }

        .bar-label {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
        }

        /* Buttons Grid */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .p-col {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .p-label {
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-indicator {
            padding: 0.5rem;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 0.7rem;
            color: #ccc;
            transition: all 0.2s;
        }

        .btn-indicator.active {
            background: black;
            color: white;
            border-color: black;
            font-weight: bold;
        }

        /* LOGS */
        .terminal-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: #111;
            color: #0f0;
            font-family: 'Bergen Mono', monospace;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .terminal-overlay.open {
            transform: translateY(0);
            pointer-events: all;
        }

        /* PRINTER WIDGET */
        .printer-widget {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .printer-widget:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 2px 2px 0 black;
        }

        .printer-icon {
            font-size: 1.2rem;
        }

        .printer-status {
            display: flex;
            flex-direction: column;
            font-size: 0.7rem;
            line-height: 1.2;
        }

        .printer-percent {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .printer-label {
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            border: 3px solid black;
            padding: 2rem;
            min-width: 500px;
            max-width: 600px;
            box-shadow: 8px 8px 0 black;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid black;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        .modal-close:hover {
            color: red;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-item {
            padding: 1rem;
            border: 1px solid #ddd;
            background: #fafafa;
        }

        .status-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .status-large {
            grid-column: 1 / -1;
            text-align: center;
            background: #000;
            color: white;
            font-size: 3rem;
        }

        .status-warning {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .status-critical {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid black;
            background: white;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: black;
            color: white;
        }

        .modal-btn.danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .modal-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
    </style>
</head>

<body>

    <svg style="display:none;">
        <symbol id="icon-play" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </symbol>
    </svg>

    <header>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <img src="/static/logo_alua.svg" height="30">
            <div>CONTROL ROOM <span style="font-size: 0.7em; color: #999;">V2.0</span></div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- PRINTER WIDGET -->
            <div class="printer-widget" onclick="openPrinterModal()">
                <div class="printer-icon">üñ®Ô∏è</div>
                <div class="printer-status">
                    <div class="printer-percent" id="printer-percent">---</div>
                    <div class="printer-label">CARTA</div>
                </div>
            </div>
            <div id="status-badge"
                style="background: black; color: white; padding: 0.25rem 0.75rem; font-weight: bold;">IDLE</div>
        </div>
    </header>

    <main>

        <!-- PANE 1: SYSTEM & CONTROLS -->
        <div class="pane">
            <div class="pane-header">Controlli Sistema</div>

            <div class="control-group">
                <div class="btn-group">
                    <button id="btn-start" class="btn btn-primary" onclick="startSystem()">
                        <div class="icon-play">‚ñ∂</div> AVVIA ESPERIENZA
                    </button>
                    <button id="btn-stop" class="btn btn-danger" onclick="stopSystem()">
                        <div class="icon-stop">‚ñ†</div> STOP EMERGENZA
                    </button>
                    <button id="btn-reset" class="btn" style="border: 1px solid #666; color: #666;"
                        onclick="resetSystem()">
                        ‚ü≥ RESET
                    </button>
                </div>
            </div>

            <div class="control-group">
                <div class="module-title">SYSTEM STATUS</div>
                <div class="chk-row">
                    <span>SERVER CONNECTION</span>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span id="lbl-server" style="font-size:0.7em;">WAIT...</span>
                        <div id="chk-server" class="check-icon"></div>
                    </div>
                </div>
                <div class="chk-row">
                    <span>ARDUINO SERIAL</span>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span id="lbl-arduino" style="font-size:0.7em;">WAIT...</span>
                        <div id="chk-arduino" class="check-icon"></div>
                    </div>
                </div>
                <div class="chk-row">
                    <span>AUDIO SYSTEM</span>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span id="lbl-audio" style="font-size:0.7em;">WAIT...</span>
                        <div id="chk-audio" class="check-icon"></div>
                    </div>
                </div>
            </div>

            <div class="control-group" style="border:none;">
                <div class="module-title">SCENARIO SYSTEM</div>

                <div
                    style="background: #111; color: white; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #fff;">
                    <div style="font-size: 0.6rem; color: #888; margin-bottom: 0.2rem;">MACRO FASE</div>
                    <div id="phase-current" style="font-size: 1.1rem; font-weight: bold;">ATTESA...</div>
                </div>

                <div
                    style="background: #fff; color: black; border: 1px solid #000; padding: 1rem; margin-bottom: 1rem;">
                    <div class="module-title" style="margin-bottom:0.5rem; border:none; padding:0;">AUDIO ENGINE</div>

                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
                        <span style="font-size:0.7rem; font-weight:bold;">NOW PLAYING</span>
                        <span id="audio-status"
                            style="font-size:0.6rem; background:black; color:white; padding:2px 4px;">IDLE</span>
                    </div>

                    <div id="audio-current"
                        style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; color: #000;">---</div>

                    <div style="border-top:1px dotted #ccc; padding-top:0.5rem;">
                        <span style="font-size:0.6rem; color:#666;">NEXT TRACK</span>
                        <div id="audio-next" style="font-weight:bold; color:#666;">---</div>
                    </div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 0.5rem;">
                    <span style="font-size: 0.8rem;">SESSION TIME:</span>
                    <span id="timer" style="font-weight: bold; font-family: monospace; font-size: 1.2rem;">00:00</span>
                </div>
            </div>

            <div style="margin-top: auto; padding: 1.5rem;">
                <button onclick="toggleTerminal()"
                    style="background:none; border:none; text-decoration:underline; font-family:inherit; cursor:pointer;">
                    Toggle Raw Logs
                </button>
            </div>
        </div>

        <!-- PANE 2: TIMELINE (SPLIT) -->
        <div class="pane pane-split" style="background: #fdfdfd;">

            <!-- LEFT: TIMELINE LIST -->
            <div class="split-left">
                <div class="pane-header">
                    <span>Timeline</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size: 0.8em; opacity: 0.5;">LIVE</span>
                        <button onclick="toggleConsole()"
                            style="background:transparent; border:1px solid #999; color:#000; cursor:pointer; font-size:0.7em; padding:2px 6px;">CONSOLE
                            ‚¨å</button>
                    </div>
                </div>
                <div id="timeline" class="timeline-list">
                    <div id="timeline-placeholder" style="text-align: center; color: #999; margin-top: 50%;">In attesa
                        di start...</div>
                </div>
            </div>

            <!-- RIGHT: CONSOLE -->
            <div id="console-subpane" class="split-right collapsed">
                <div class="pane-header" style="background:#222; color:#fff; border-bottom:1px solid #444;">
                    <span>RAW LOGS</span>
                    <span style="font-size:0.7em; opacity:0.5;">‚óè LIVE</span>
                </div>
                <div id="terminal" class="terminal-content">
                    <div style="color:#666;">Waiting for logs...</div>
                </div>
            </div>
        </div>

        <!-- PANE 3: LIVE DATA -->
        <div class="pane">
            <div class="pane-header">Dati Sensori</div>

            <!-- BUTTONS MATRIX -->
            <div class="module">
                <div class="module-title">RELAZIONI (Bottoni)</div>
                <div class="btn-grid">
                    <div class="p-col">
                        <div class="p-label">CONTRAENTE A</div>
                        <div id="btn-a-0" class="btn-indicator">CIRCOSTANZIALE</div>
                        <div id="btn-a-1" class="btn-indicator">ROMANTICA</div>
                        <div id="btn-a-2" class="btn-indicator">LAVORATIVA</div>
                        <div id="btn-a-3" class="btn-indicator">AMICALE</div>
                        <div id="btn-a-4" class="btn-indicator">FAMILIARE</div>
                        <div id="btn-a-5" class="btn-indicator">CONVIVENZA</div>
                    </div>
                    <div class="p-col">
                        <div class="p-label">CONTRAENTE B</div>
                        <div id="btn-b-0" class="btn-indicator">CIRCOSTANZIALE</div>
                        <div id="btn-b-1" class="btn-indicator">ROMANTICA</div>
                        <div id="btn-b-2" class="btn-indicator">LAVORATIVA</div>
                        <div id="btn-b-3" class="btn-indicator">AMICALE</div>
                        <div id="btn-b-4" class="btn-indicator">FAMILIARE</div>
                        <div id="btn-b-5" class="btn-indicator">CONVIVENZA</div>
                    </div>
                </div>
            </div>

            <!-- SLIDERS -->
            <div class="module">
                <div class="module-title">INTENSIT√Ä (Slider)</div>
                <div class="slider-viz">
                    <div>
                        <div class="bar-container">
                            <div id="bar-s0" class="bar-fill" style="height: 0%"></div>
                        </div>
                        <div class="bar-label">A</div>
                    </div>
                    <div>
                        <div class="bar-container">
                            <div id="bar-s1" class="bar-fill" style="height: 0%"></div>
                        </div>
                        <div class="bar-label">B</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; font-family: monospace;">
                    <span id="val-s0">0</span> / <span id="val-s1">0</span>
                </div>
            </div>

            <!-- SENSORS -->
            <div class="module" style="border:none;">
                <div class="module-title">BIOMETRICA (GSR)</div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                    <div>A: <span id="val-gsr0">---</span></div>
                    <div>B: <span id="val-gsr1">---</span></div>
                </div>
                <div style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 0.5rem;">
                    <div style="display:flex; justify-content: space-between; align-items: center;">
                        <span>CONTATTO MANI:</span>
                        <div id="contact-indicator"
                            style="width: 15px; height: 15px; border-radius: 50%; border: 1px solid black;"></div>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- PRINTER MODAL -->
    <div id="printer-modal" class="modal-overlay" onclick="closePrinterModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">üñ®Ô∏è Stato Rotolo Termico</div>
                <button class="modal-close" onclick="closePrinterModal()">√ó</button>
            </div>

            <div class="status-grid">
                <div class="status-item status-large" id="modal-percent">
                    <div class="status-value">---</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Carta Rimanente</div>
                    <div class="status-value" id="modal-remaining">--- mm</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Lunghezza Iniziale</div>
                    <div class="status-value" id="modal-initial">--- mm</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Contratti Stampati</div>
                    <div class="status-value" id="modal-printed">---</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Media per Contratto</div>
                    <div class="status-value" id="modal-average">--- mm</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Contratti Stimati</div>
                    <div class="status-value" id="modal-estimated">---</div>
                </div>

                <div class="status-item">
                    <div class="status-label">Ultimo Aggiornamento</div>
                    <div class="status-value" style="font-size: 0.9rem;" id="modal-updated">---</div>
                </div>
            </div>

            <div id="modal-message"
                style="padding: 1rem; text-align: center; font-weight: bold; border: 2px solid #ddd; margin-bottom: 1rem;">
                ---
            </div>

            <!-- RESET PANEL (Hidden by default) -->
            <div id="reset-panel"
                style="display: none; padding: 1.5rem; border: 2px solid #dc3545; background: #fff; margin-bottom: 1rem;">
                <div style="font-weight: bold; margin-bottom: 1rem; color: #dc3545;">
                    ‚ö†Ô∏è RESET ROTOLO TERMICO
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem;">Lunghezza nuovo rotolo
                        (mm):</label>
                    <input type="number" id="reset-length-input" value="30000" min="1" max="100000"
                        style="width: 100%; padding: 0.75rem; font-family: inherit; font-size: 1rem; border: 2px solid #000;">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="modal-btn" onclick="cancelReset()" style="flex: 1;">Annulla</button>
                    <button class="modal-btn danger" onclick="confirmReset()" style="flex: 1;">‚úì Conferma Reset</button>
                </div>
            </div>

            <div id="modal-actions" class="modal-actions">
                <button class="modal-btn" onclick="closePrinterModal()">Chiudi</button>
                <button class="modal-btn danger" onclick="showResetPanel()">üîÑ Reset Rotolo</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const wsUrl = `ws://${window.location.host}/ws/logs`;
        let ws;
        let startTime = null;
        let timerInterval;
        let isExperienceRunning = false;

        // --- DOM REFS ---
        const dom = {
            timeline: document.getElementById('timeline'),
            terminal: document.getElementById('terminal'),
            btnStart: document.getElementById('btn-start'),
            status: document.getElementById('status-badge'),

            // Phase UI
            phaseCurrent: document.getElementById('phase-current'),

            // Audio UI
            audioCurrent: document.getElementById('audio-current'),
            audioNext: document.getElementById('audio-next'),
            audioStatus: document.getElementById('audio-status'),

            timer: document.getElementById('timer'),

            checks: {
                server: document.getElementById('chk-server'),
                arduino: document.getElementById('chk-arduino'),
                audio: document.getElementById('chk-audio'),
            },
            data: {
                s0: document.getElementById('bar-s0'),
                s1: document.getElementById('bar-s1'),
                vs0: document.getElementById('val-s0'),
                vs1: document.getElementById('val-s1'),
                gsr0: document.getElementById('val-gsr0'),
                gsr1: document.getElementById('val-gsr1'),
                contact: document.getElementById('contact-indicator')
            }
        };

        const BUTTON_KEYS = [
            "CIRCOSTANZIALE", "ROMANTICA", "LAVORATIVA", "AMICALE", "FAMILIARE", "CONVIVENZA"
        ];

        const EXPERIENCE_SEQUENCE = {
            "01": { desc: "Intro (01)", next: "02" },
            "02": { desc: "Istruzioni (02)", next: "03 (Start Monitoraggio)" },
            "03": { desc: "Prima Fase (03)", next: "04" },
            "04": { desc: "Guida (04)", next: "04.1" },
            "04.1": { desc: "Deepening (04.1)", next: "05" },
            "05": { desc: "Immersione (05)", next: "06" },
            "06": { desc: "Sensazioni (06)", next: "06.1" },
            "06.1": { desc: "Focus (06.1)", next: "07 (Transizione)" },
            "07": { desc: "Transizione (07)", next: "08" },
            "08": { desc: "Prepare Trigger (08)", next: "09" },
            "09": { desc: "Ready Trigger (09)", next: "10 (Check Contatto)" },
            "10": { desc: "Trigger Active (10)", next: "11 (Seconda Fase)" },
            "11": { desc: "Seconda Fase (11)", next: "12" },
            "12": { desc: "Intensit√† (12)", next: "12.1 (Conclusione)" },
            "12.1": { desc: "Outro (12.1)", next: "FINE" },
        };

        // --- INIT ---
        function init() {
            connectWs();
        }

        function connectWs() {
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                updateCheckUI('server', 'OK', "CONNESSO");
                log("WS Connected", true);
            };
            ws.onclose = () => {
                updateCheckUI('server', 'ERR', "DISCONNESSO");
                setTimeout(connectWs, 2000);
            };
            ws.onmessage = (e) => handleMessage(e.data);
        }

        function handleMessage(raw) {
            let isProtocol = false;
            let data = null;

            try {
                if (raw.trim().startsWith('{')) {
                    data = JSON.parse(raw);
                    if (data.type) {
                        isProtocol = true;
                        processEvent(data);
                    }
                }
            } catch (e) { }

            if (!isProtocol) {
                const div = document.createElement('div');
                div.textContent = raw;
                dom.terminal.appendChild(div);
                dom.terminal.scrollTop = dom.terminal.scrollHeight;
                if (dom.terminal.children.length > 200) dom.terminal.removeChild(dom.terminal.firstChild);
            }

            if (!isProtocol) {
                if (raw.includes("[AUDIO]")) {
                    const audioId = raw.match(/audio ([\d\.]+)/)?.[1];
                    if (audioId) processEvent({ type: 'STEP', category: 'AUDIO', status: 'RUNNING', detail: audioId });
                }
                if (raw.includes("FINE DELL'ESPERIENZA")) {
                    setStatus("FINISHED");
                    stopTimer();
                    dom.phaseCurrent.innerText = "COMPLETATO";
                    updateAudioUI("---", "---", "IDLE");
                }
            }
        }

        function processEvent(evt) {
            if (evt.type === 'DATA') {
                updateLiveData(evt.payload);
            }
            else if (evt.type === 'CHECK') {
                const map = {
                    'AUDIO_FILES': 'audio',
                    'AUDIO': 'audio',
                    'ARDUINO': 'arduino',
                    'DB_CONNECTION': 'server'
                };
                if (map[evt.component]) {
                    updateCheckUI(map[evt.component], evt.status === 'OK' ? 'OK' : 'ERR', evt.detail || evt.status);
                }
            }
            else if (evt.type === 'STEP') {
                addTimelineItem(evt.category, evt.detail);
                if (evt.category === 'AUDIO') {
                    if (evt.status === 'RUNNING') {
                        const seq = EXPERIENCE_SEQUENCE[evt.detail];
                        const label = seq ? seq.desc : `Audio ${evt.detail}`;
                        const next = seq ? seq.next : "...";
                        updateAudioUI(label, next, "PLAYING");
                    } else if (evt.status === 'DONE') {
                        updateAudioUI("---", "Wait...", "IDLE");
                    }
                }
            }
            else if (evt.type === 'PHASE') {
                if (!isExperienceRunning || evt.name === "PRE-MONITORAGGIO") {
                    startTimer();
                    isExperienceRunning = true;
                    setStatus("RUNNING");
                }
                addTimelineItem("PHASE", evt.name);
                dom.phaseCurrent.innerText = evt.name;
                dom.phaseCurrent.style.color = "#22c55e";
                setTimeout(() => { dom.phaseCurrent.style.color = "white"; }, 500);
            }
            else if (evt.type === 'SYNC') {
                restoreState(evt.payload);
            }
        }

        function restoreState(s) {
            console.log("Restoring state:", s);
            if (s.is_started) {
                isExperienceRunning = true;
                setStatus("RUNNING");
                startTimer();
            }
            if (s.last_phase) processEvent(s.last_phase);
            if (s.current_audio) processEvent(s.current_audio);
            if (s.last_data) updateLiveData(s.last_data.payload);

            // NEW: Restore checks
            if (s.checks) {
                for (const key in s.checks) {
                    processEvent(s.checks[key]);
                }
            }
        }

        function updateAudioUI(current, next, status) {
            dom.audioCurrent.innerText = current;
            dom.audioNext.innerText = next;
            dom.audioStatus.innerText = status;
            if (status === 'PLAYING') {
                dom.audioStatus.style.background = "#22c55e";
                dom.audioStatus.classList.add('blink');
            } else {
                dom.audioStatus.style.background = "black";
                dom.audioStatus.classList.remove('blink');
            }
        }

        function updateCheckUI(id, status, text) {
            const icon = dom.checks[id];
            const label = document.getElementById(`lbl-${id}`);
            icon.className = `check-icon ${status.toLowerCase()}`;
            if (label) {
                label.innerText = text;
                label.style.color = status === 'OK' ? '#22c55e' : '#ef4444';
            }
        }

        function updateLiveData(d) {
            const p0 = Math.min(100, Math.max(0, (d.SLIDER0 / 1023) * 100));
            const p1 = Math.min(100, Math.max(0, (d.SLIDER1 / 1023) * 100));
            dom.data.s0.style.height = p0 + "%";
            dom.data.s1.style.height = p1 + "%";
            dom.data.vs0.innerText = d.SLIDER0;
            dom.data.vs1.innerText = d.SLIDER1;
            dom.data.gsr0.innerText = d.SCL0;
            dom.data.gsr1.innerText = d.SCL1;
            dom.data.contact.style.background = d.CONTATTO > 0 ? "#22c55e" : "transparent";

            document.querySelectorAll('.btn-indicator').forEach(b => b.classList.remove('active'));
            d.RELAZIONI_P0.forEach(rel => {
                const idx = BUTTON_KEYS.indexOf(rel);
                if (idx >= 0) document.getElementById(`btn-a-${idx}`)?.classList.add('active');
            });
            d.RELAZIONI_P1.forEach(rel => {
                const idx = BUTTON_KEYS.indexOf(rel);
                if (idx >= 0) document.getElementById(`btn-b-${idx}`)?.classList.add('active');
            });
        }

        function addTimelineItem(title, meta) {
            const div = document.createElement('div');
            div.className = "t-item active";
            const timeStr = new Date().toLocaleTimeString().split(' ')[0];
            let icon = '';
            if (title === 'PHASE') icon = 'üî¥';
            if (title === 'AUDIO') icon = 'üéµ';

            div.innerHTML = `
                <div class="t-time">${timeStr}</div>
                <div class="t-content">
                    <div class="t-title">${icon} ${title}</div>
                    <div class="t-meta">${meta}</div>
                </div>
            `;
            const ph = document.getElementById('timeline-placeholder');
            if (ph) ph.remove();
            dom.timeline.insertBefore(div, dom.timeline.firstChild);
        }

        function startSystem() {
            fetch('/api/start', { method: 'POST' });
            dom.timeline.innerHTML = '<div id="timeline-placeholder" style="text-align: center; color: #999; margin-top: 50%;">In attesa di start...</div>';
            dom.checks.arduino.className = "check-icon";
            dom.checks.audio.className = "check-icon";
            dom.phaseCurrent.innerText = "AVVIO...";
            updateAudioUI("---", "...", "IDLE");
            dom.timer.innerText = "00:00";
            isExperienceRunning = false;
        }

        function stopSystem() {
            fetch('/api/stop', { method: 'POST' });
            isExperienceRunning = false;
            stopTimer();
            dom.phaseCurrent.innerText = "STOPPED";
        }

        function resetSystem() {
            stopSystem();
            dom.timeline.innerHTML = '<div id="timeline-placeholder" style="text-align: center; color: #999; margin-top: 50%;">In attesa di start...</div>';
            dom.terminal.innerHTML = '';
            setStatus("READY");
            dom.timer.innerText = "00:00";
            dom.phaseCurrent.innerText = "IN ATTESA...";
            updateAudioUI("---", "---", "IDLE");
            ['server', 'arduino', 'audio'].forEach(id => {
                updateCheckUI(id, 'WAIT', 'WAIT...');
            });
            if (ws && ws.readyState === WebSocket.OPEN) {
                updateCheckUI('server', 'OK', "CONNESSO");
            }
        }

        function log(msg) {
            console.log(msg);
        }

        function toggleConsole() {
            const pane = document.getElementById('console-subpane');
            pane.classList.toggle('collapsed');
        }

        function setStatus(s) {
            dom.status.innerText = s;
        }

        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                dom.timer.innerText = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- PRINTER WIDGET FUNCTIONS ---
        let printerStatusInterval;

        async function fetchPrinterStatus() {
            try {
                const response = await fetch('/api/roll-status');
                const data = await response.json();
                updatePrinterUI(data);
            } catch (error) {
                console.error('Error fetching printer status:', error);
                document.getElementById('printer-percent').innerText = 'ERR';
            }
        }

        function updatePrinterUI(data) {
            // Update widget badge
            const widgetPercent = document.getElementById('printer-percent');
            const widget = document.querySelector('.printer-widget');

            if (!data.initialized) {
                widgetPercent.innerText = 'N/A';
                widget.style.borderColor = '#999';
            } else {
                widgetPercent.innerText = Math.round(data.remaining_percentage) + '%';

                // Color coding
                if (data.status === 'critical') {
                    widget.style.borderColor = '#dc3545';
                    widget.style.background = '#f8d7da';
                } else if (data.status === 'warning') {
                    widget.style.borderColor = '#ffc107';
                    widget.style.background = '#fff3cd';
                } else {
                    widget.style.borderColor = '#000';
                    widget.style.background = 'white';
                }
            }

            // Update modal
            if (data.initialized) {
                const percent = Math.round(data.remaining_percentage);
                document.getElementById('modal-percent').innerHTML = `<div class="status-value">${percent}%</div>`;
                document.getElementById('modal-remaining').innerText = data.remaining_mm + ' mm';
                document.getElementById('modal-initial').innerText = data.initial_length_mm + ' mm';
                document.getElementById('modal-printed').innerText = data.contracts_printed;
                document.getElementById('modal-average').innerText = data.average_mm_per_contract + ' mm';
                document.getElementById('modal-estimated').innerText = data.estimated_contracts_remaining;
                document.getElementById('modal-updated').innerText = data.last_updated || '---';

                const modalMessage = document.getElementById('modal-message');
                modalMessage.innerText = data.message;
                modalMessage.className = '';
                modalMessage.style.border = '2px solid #ddd';

                if (data.status === 'critical') {
                    modalMessage.style.background = '#f8d7da';
                    modalMessage.style.borderColor = '#dc3545';
                    modalMessage.style.color = '#dc3545';
                } else if (data.status === 'warning') {
                    modalMessage.style.background = '#fff3cd';
                    modalMessage.style.borderColor = '#ffc107';
                    modalMessage.style.color = '#856404';
                } else {
                    modalMessage.style.background = '#d4edda';
                    modalMessage.style.borderColor = '#22c55e';
                    modalMessage.style.color = '#155724';
                }

                // Color percentage box
                const percentBox = document.getElementById('modal-percent');
                if (data.status === 'critical') {
                    percentBox.style.background = '#dc3545';
                } else if (data.status === 'warning') {
                    percentBox.style.background = '#ffc107';
                    percentBox.style.color = '#000';
                } else {
                    percentBox.style.background = '#000';
                    percentBox.style.color = '#fff';
                }
            } else {
                document.getElementById('modal-percent').innerHTML = '<div class="status-value">N/A</div>';
                document.getElementById('modal-message').innerText = data.message || 'Rotolo non inizializzato';
            }
        }

        function openPrinterModal() {
            fetchPrinterStatus(); // Refresh data when opening
            document.getElementById('printer-modal').classList.add('open');
        }

        function closePrinterModal(event) {
            if (event && event.target.id !== 'printer-modal') return;
            document.getElementById('printer-modal').classList.remove('open');
            // Ensure reset panel is hidden when closing modal
            cancelReset();
        }

        async function resetPrinterRoll() {
            // Show reset panel instead of using prompt
            showResetPanel();
        }

        function showResetPanel() {
            document.getElementById('reset-panel').style.display = 'block';
            document.getElementById('modal-actions').style.display = 'none';
            document.getElementById('reset-length-input').focus();
        }

        function cancelReset() {
            document.getElementById('reset-panel').style.display = 'none';
            document.getElementById('modal-actions').style.display = 'flex';
        }

        async function confirmReset() {
            const lengthInput = document.getElementById('reset-length-input');
            const lengthMm = parseInt(lengthInput.value);

            if (isNaN(lengthMm) || lengthMm <= 0 || lengthMm > 100000) {
                alert('Lunghezza non valida! Usa un valore tra 1 e 100000 mm.');
                return;
            }

            try {
                const response = await fetch(`/api/roll-reset?length_mm=${lengthMm}`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    fetchPrinterStatus(); // Refresh display
                    cancelReset(); // Hide reset panel
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('Errore durante il reset: ' + error.message);
            }
        }

        // --- INIT ---
        function init() {
            console.log("Initializing Dashboard...");
            connectWs();

            // Start printer status polling
            fetchPrinterStatus();
            printerStatusInterval = setInterval(fetchPrinterStatus, 10000); // Every 10 seconds
        }

        init();
    </script>
</body>

</html>